function isObject(value) {
  return value && typeof value === 'object' && !Array.isArray(value);
}

function mergeInto(target, source, customizer) {
  if (!isObject(source)) return target;

  Object.keys(source).forEach((key) => {
    const srcVal = source[key];
    const tgtVal = target[key];

    if (typeof customizer === 'function') {
      const customized = customizer(tgtVal, srcVal, key, target, source);
      if (customized !== undefined) {
        target[key] = customized;
        return;
      }
    }

    if (isObject(tgtVal) && isObject(srcVal)) {
      target[key] = mergeInto({ ...tgtVal }, srcVal, customizer);
    } else {
      target[key] = srcVal;
    }
  });

  return target;
}

function mergeWith(object, ...rest) {
  const target = object || {};
  let customizer;

  if (rest.length && typeof rest[rest.length - 1] === 'function') {
    customizer = rest.pop();
  }

  for (const source of rest) {
    mergeInto(target, source, customizer);
  }

  return target;
}

module.exports = mergeWith;

